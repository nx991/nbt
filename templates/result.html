<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NIMNABRO VPN | Usage Details</title>
  <link rel="icon" type="image/png" href="https://www.dropbox.com/scl/fi/us9bg2xv9agp03izul2yq/channels4_profile_1-modified-1.png?rlkey=224q0p35gk2jum9rp40vvvpxc&raw=1">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- Google Fonts: Russo One & Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- ApexCharts for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* --- Core styles from index.html for visual consistency --- */
    body {
      font-family: 'Russo One', sans-serif;
      color: #cbd5e1; /* slate-300 */
      letter-spacing: 0.5px;
      background-color: #0f172a; /* Fallback background */
    }

    #bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -100;
      filter: blur(10px);
      -webkit-filter: blur(10px);
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }

    .card {
      background-color: rgba(10, 10, 20, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(6, 182, 212, 0.1);
      border-color: #06b6d4;
      background-color: rgba(10, 10, 20, 0.75);
    }

    .card::after {
        content: '';
        position: absolute;
        top: 0;
        left: -150%;
        width: 100%;
        height: 100%;
        transform: skewX(-20deg);
        background-image: linear-gradient(100deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
        transition: left 0.7s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .card:hover::after {
        left: 150%;
    }

    /* --- Styles kept from original result.html --- */
    .progress-bar {
        transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1), background-color .4s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .anim-fadeIn {
      animation: fadeIn 0.6s ease-out forwards;
    }

    .sans-fallback {
        font-family: 'Inter', sans-serif;
        letter-spacing: normal;
    }
  </style>
</head>
<body class="antialiased">

  <video autoplay muted loop id="bg-video">
    <!-- The video source is now loaded dynamically by the script below -->
    Your browser does not support HTML5 video.
  </video>

  <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative z-10">
    <!-- Header -->
    <header class="text-center mb-10">
      <h1 class="text-5xl sm:text-6xl font-bold tracking-wider text-white">
        Usage Details
      </h1>
      <p class="text-slate-400 mt-2 text-xl sans-fallback">User: {{ email }}</p>
    </header>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      <!-- User Overview -->
      <div class="card rounded-xl p-6 opacity-0 group">
        <h3 class="flex items-center gap-3 text-3xl text-white mb-4">
          <i class="fas fa-id-badge text-cyan-400 transition-transform duration-300 group-hover:scale-110 group-hover:-rotate-6"></i>
          <span>User Overview</span>
        </h3>
        <div class="space-y-3 sans-fallback text-lg">
            <!-- Using a slightly different background for inner elements to improve readability on the new glass background -->
            <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg">
                <span class="font-semibold">Config Status</span>
                <div id="status-display" class="flex items-center gap-2">
                    <!-- This content is generated by JavaScript -->
                </div>
            </div>
            <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg">
                <span class="font-semibold">Expiry Date</span>
                <span id="expiry-badge" class="font-bold text-white">{{ expiry_date }}</span>
            </div>
        </div>
      </div>

      <!-- Usage (numbers + progress) -->
      <div class="card rounded-xl p-6 opacity-0 group">
        <h3 class="flex items-center gap-3 text-3xl text-white mb-4">
          <i class="fas fa-gauge-high text-cyan-400 transition-transform duration-300 group-hover:scale-110 group-hover:-rotate-6"></i>
          <span>Data Usage</span>
        </h3>
        <div class="space-y-4 sans-fallback text-lg">
            <div>
                <div class="flex justify-between mb-1"><span class="font-semibold">Uploaded</span><span class="font-bold text-white">{{ up }}</span></div>
                <div class="w-full bg-slate-700/80 rounded-full h-2.5"><div id="uploaded-bar" class="progress-bar h-2.5 rounded-full"></div></div>
            </div>
            <div>
                <div class="flex justify-between mb-1"><span class="font-semibold">Downloaded</span><span class="font-bold text-white">{{ down }}</span></div>
                <div class="w-full bg-slate-700/80 rounded-full h-2.5"><div id="downloaded-bar" class="progress-bar h-2.5 rounded-full"></div></div>
            </div>
            <div>
                <div class="flex justify-between mb-1"><span class="font-semibold">Total Used</span><span class="font-bold text-white" id="total-used-badge">...</span></div>
                <div class="w-full bg-slate-700/80 rounded-full h-2.5"><div id="limit-bar" class="progress-bar h-2.5 rounded-full"></div></div>
            </div>
        </div>
      </div>

      <!-- Quick Info -->
      <div class="card rounded-xl p-6 opacity-0 group">
        <h3 class="flex items-center gap-3 text-3xl text-white mb-4">
            <i class="fas fa-circle-info text-cyan-400 transition-transform duration-300 group-hover:scale-110 group-hover:-rotate-6"></i>
            <span>Quick Info</span>
        </h3>
        <div class="space-y-3 sans-fallback text-lg">
             <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg">
                <span class="font-semibold">Data Limit</span>
                <span class="font-bold text-white">{{ total }}</span>
            </div>
            <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg">
                <span class="font-semibold">Remaining</span>
                <span id="remaining-badge" class="font-bold text-white">...</span>
            </div>
             <div class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg">
                <span class="font-semibold">Utilization</span>
                <span id="utilization-badge" class="font-bold text-white">...</span>
            </div>
        </div>
      </div>
      
      <!-- Summary Chart (Upload/Download vs Remaining) -->
      <div class="card rounded-xl p-6 opacity-0 group md:col-span-2">
        <h3 class="flex items-center gap-3 text-3xl text-white mb-2">
            <i class="fas fa-chart-line text-cyan-400 transition-transform duration-300 group-hover:scale-110 group-hover:-rotate-6"></i>
            <span>Usage Summary (Live)</span>
        </h3>
        <div id="summary-chart" class="w-full h-64"></div>
      </div>

      <!-- Expiry Bar (New Component) -->
      <div class="card rounded-xl p-6 opacity-0 group flex flex-col justify-center">
        <h3 class="flex items-center gap-3 text-3xl text-white mb-4">
            <i class="far fa-clock text-cyan-400 transition-transform duration-300 group-hover:scale-110 group-hover:-rotate-6"></i>
            <span>Days to Expiry</span>
        </h3>
        <div class="text-center">
            <div id="days-left-display" class="text-7xl font-bold text-white transition-colors">0</div>
            <p id="days-left-subtext" class="text-slate-400 -mt-1 text-lg sans-fallback">Days Remaining</p>
        </div>
        <div class="w-full bg-slate-700/80 rounded-full h-4 mt-4 overflow-hidden">
            <div id="days-left-bar" class="h-4 rounded-full progress-bar" style="width: 0%;"></div>
        </div>
        <p id="expiry-desc" class="text-center mt-3 sans-fallback text-lg h-6"></p>
      </div>

    </div>

    <!-- Footer / Back Button -->
    <footer class="text-center mt-12 py-6 border-t border-slate-700/50 sans-fallback">
       <a href="/" class="inline-block bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 active:scale-95 text-2xl">
          <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
       </a>
      <p class="text-slate-500 mt-6">&copy; 2025 NIMNABRO All rights reserved.</p>
      <div class="mt-4">
        <a href="https://guns.lol/nimnabro" target="_blank" class="inline-block text-slate-400 hover:text-cyan-400 transition-colors duration-300 text-3xl">
          <i class="fas fa-link"></i>
        </a>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const videoElement = document.getElementById('bg-video');

      // Add listener to fade in video when ready
      videoElement.addEventListener('canplay', () => {
        videoElement.style.opacity = '1';
      });

      // --- DYNAMIC VIDEO LOADER ---
      const videoUrlGist = 'https://gist.githubusercontent.com/nx991/3e1ac6d1bb159e30b1d4c013f2cc7785/raw/video.txt';
      
      fetch(videoUrlGist)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(videoUrl => {
            if (videoElement && videoUrl && videoUrl.trim() !== '') {
                videoElement.src = videoUrl.trim();
                videoElement.load();
                const playPromise = videoElement.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Autoplay for dynamic video was prevented:", error);
                    });
                }
            } else {
                throw new Error('Fetched video URL is empty.');
            }
        })
        .catch(error => {
            console.error('Failed to fetch dynamic video URL, using fallback:', error);
            if (videoElement) {
                 videoElement.src = 'https://files.catbox.moe/mj9qr1.mp4';
                 videoElement.load();
                 const playPromise = videoElement.play();
                 if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Autoplay for fallback video was prevented:", error);
                    });
                 }
            }
        });
      // --- END DYNAMIC VIDEO LOADER ---

      // --- UI Animation ---
      const cards = document.querySelectorAll('.card');
      cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 100}ms`;
        card.classList.add('anim-fadeIn');
      });
    });
    
    // --- BASE CODE IS PRESERVED AND ADAPTED FOR NEW UI ---
    // (No changes were made to the script below)

    // ===== Helpers =====
    function parseNum(str){ if (!str) return 0; const m=String(str).match(/[\d.]+/); return m?parseFloat(m[0]):0; }
    function unit(str){ if (!str) return ""; const m=String(str).match(/[a-zA-Z]+/g); return m?m.join(""):""; }
    function toMB(value, u){
      const U = (u||"").toUpperCase();
      if (U.includes("TB")) return value*1024*1024;
      if (U.includes("GB")) return value*1024;
      if (U.includes("MB")) return value;
      if (U.includes("KB")) return value/1024;
      return value;
    }
    // Animate integer values
    function animateValue(obj, start, end, duration) {
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const currentValue = Math.floor(progress * (end - start) + start);
        obj.innerHTML = `${currentValue}`;
        if (progress < 1) {
          window.requestAnimationFrame(step);
        } else {
            obj.innerHTML = `${end}`;
        }
      };
      window.requestAnimationFrame(step);
    }

    // ===== Read values from Jinja =====
    const upStr = "{{ up }}";
    const downStr = "{{ down }}";
    const totalStr = "{{ total }}";
    const userStatus = ("{{ user_status }}".trim().toLowerCase() === "enabled");
    const expiryStr = "{{ expiry_date }}";

    // Convert to MB for math
    let upMB = toMB(parseNum(upStr), unit(upStr));
    let downMB = toMB(parseNum(downStr), unit(downStr));
    let totalMB = toMB(parseNum(totalStr), unit(totalStr));
    let usedMB = upMB + downMB;
    let remainingMB = Math.max(totalMB - usedMB, 0);
    let utilization = totalMB > 0 ? (usedMB / totalMB * 100) : 0;

    // ===== Update quick badges =====
    const fmt = (mb) => {
      if (mb >= 1024*1024) return (mb/1024/1024).toFixed(2)+" TB";
      if (mb >= 1024) return (mb/1024).toFixed(2)+" GB";
      return mb.toFixed(2)+" MB";
    };
    document.getElementById("total-used-badge").textContent = fmt(usedMB);
    document.getElementById("remaining-badge").textContent  = fmt(remainingMB);
    document.getElementById("utilization-badge").textContent = utilization.toFixed(1)+"%";

    // ===== Progress bars =====
    function setBar(id, valueMB, maxMB){
      const el = document.getElementById(id);
      if (!el || maxMB<=0) return;
      const p = Math.max(0, Math.min(100, valueMB/maxMB*100));
      el.style.width = p + "%";
      // color ramp matching new theme
      if (p <= 70) el.style.backgroundColor = "#06b6d4"; // cyan-500
      else if (p <= 90) el.style.backgroundColor = "#facc15"; // yellow-400
      else el.style.backgroundColor = "#ef4444"; // red-500
    }
    setTimeout(()=> {
      setBar("uploaded-bar", upMB, totalMB);
      setBar("downloaded-bar", downMB, totalMB);
      setBar("limit-bar", usedMB, totalMB);
    }, 300);

    // ===== Status Display (No longer a toggle) =====
    const statusDisplay = document.getElementById("status-display");
    
    function applyStatusUI(enabled){
      if(enabled) {
        statusDisplay.innerHTML = `
          <span class="font-bold text-green-400">Enabled</span>
          <i class="fas fa-check-circle text-green-400"></i>
        `;
      } else {
        statusDisplay.innerHTML = `
          <span class="font-bold text-red-400">Disabled</span>
          <i class="fas fa-times-circle text-red-400"></i>
        `;
      }
    }
    applyStatusUI(userStatus);

    // ===== Expiry Bar & copy (New Logic) =====
    function daysUntil(dateStr){
      const d = new Date(dateStr.replace(" ", "T")+"Z");
      if (isNaN(d.getTime())) return null;
      return Math.ceil((d.getTime() - new Date().getTime())/(1000*60*60*24));
    }
    const dLeft = daysUntil(expiryStr);
    const expiryDesc = document.getElementById("expiry-desc");
    const daysDisplay = document.getElementById("days-left-display");
    const daysBar = document.getElementById("days-left-bar");
    const daysSubtext = document.getElementById("days-left-subtext");
    
    const finalDays = dLeft !== null ? dLeft : 0;
    animateValue(daysDisplay, 0, Math.abs(finalDays), 800);

    if (dLeft === null){
      expiryDesc.textContent = "Invalid expiry date.";
      daysDisplay.textContent = 'N/A';
    } else if (dLeft < 0){
      expiryDesc.innerHTML = `<span class="text-red-400">Expired ${Math.abs(dLeft)} days ago</span>`;
      daysDisplay.classList.add('text-red-400');
      daysSubtext.textContent = 'Days Ago';
    } else {
      expiryDesc.innerHTML = `<span>&nbsp;</span>`; // Keep space consistent
    }

    // Calculate percentage for the bar (based on a 30-day period)
    const pct = dLeft !== null ? Math.max(0, Math.min(100, (dLeft / 30) * 100)) : 0;
    
    // Set bar color and animate width
    setTimeout(() => {
        daysBar.style.width = pct + '%';
        if (dLeft === null || dLeft < 0) {
            daysBar.style.width = '100%';
            daysBar.style.backgroundColor = '#ef4444'; // red-500
        } else if (dLeft <= 3) {
            daysBar.style.backgroundColor = '#ef4444'; // red-500
        } else if (dLeft <= 7) {
            daysBar.style.backgroundColor = '#facc15'; // yellow-400
        } else {
            daysBar.style.backgroundColor = '#22c55e'; // green-500
        }
    }, 300);

    // ===== Charts (ApexCharts) =====
    const summaryOptions = {
      chart: { type: 'bar', height: '100%', foreColor:'#cbd5e1', toolbar: { show: false } },
      series: [
        { name:'Uploaded', data:[upMB] },
        { name:'Downloaded', data:[downMB] },
        { name:'Remaining', data:[remainingMB] },
      ],
      colors: ['#22d3ee', '#818cf8', '#334155'], // cyan-400, indigo-400, slate-700
      xaxis: { categories: ['Data'], labels:{style:{colors:'#cbd5e1'}} },
      yaxis: { labels:{ formatter:(v)=> v>=1024? (v/1024).toFixed(1)+' GB' : v.toFixed(0)+' MB' } },
      plotOptions: { bar:{ horizontal: false, columnWidth:'50%', borderRadius: 6 } },
      dataLabels: { enabled:false },
      tooltip: { theme: 'dark', y:{ formatter:(v)=> v>=1024? (v/1024).toFixed(2)+' GB' : v.toFixed(2)+' MB' } },
      grid: { borderColor: 'rgba(255,255,255,.15)' },
      legend:{ position:'top', horizontalAlign: 'left' }
    };
    new ApexCharts(document.querySelector("#summary-chart"), summaryOptions).render();

  </script>

</body>
</html>

